<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Completing Sign In – Ecstasy Retreat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    body { background: #0b0b0f; color: #fff; }
    .card { max-width: 540px; margin: 120px auto; padding: 32px; border-radius: 18px; background: rgba(17,17,24,0.85); border: 1px solid rgba(244,114,182,0.35); box-shadow: 0 18px 40px rgba(0,0,0,0.4); }
    .banner { border-radius: 12px; padding: 12px 14px; margin-top: 16px; display: none; }
    .banner.error { display: block; background: rgba(239, 68, 68, 0.12); border: 1px solid rgba(239,68,68,0.6); color: #fecdd3; }
    .banner.success { display: block; background: rgba(34,197,94,0.12); border: 1px solid rgba(34,197,94,0.6); color: #bbf7d0; }
  </style>
  <script src="js/uiErrorHandler.js"></script>
</head>
<body>
  <main class="card text-center space-y-4">
    <div class="text-3xl font-bold text-pink-400">Finalizing Google sign-in…</div>
    <p id="status" class="text-gray-300">Checking your Supabase session. Please wait.</p>
    <div id="errorBanner" class="banner error"></div>
    <div id="successBanner" class="banner success"></div>
    <p class="text-xs text-gray-400">If this takes longer than a few seconds, please try again. Ensure the redirect URL is allowed in your Supabase Google provider settings: https://virtualwarecloud.github.io/EcstasyRetreat/auth-callback.html</p>
  </main>

  <script type="module">
    import { supabase } from "./js/supabaseClient.js";
    import { watchAuthState } from "./js/auth.js";

    const statusEl = document.getElementById("status");
    const errorBanner = document.getElementById("errorBanner");
    const successBanner = document.getElementById("successBanner");

    function showError(message) {
      console.error("OAuth callback error:", message);
      errorBanner.textContent = message;
      errorBanner.style.display = "block";
      successBanner.style.display = "none";
      statusEl.textContent = "";
      window.uiErrorHandler?.showError?.(message);
    }

    function showSuccess(message) {
      successBanner.textContent = message;
      successBanner.style.display = "block";
      errorBanner.style.display = "none";
    }

    // Log auth state transitions for debugging and resilience on GitHub Pages hosting.
    watchAuthState({
      onChange: (event) => {
        if (event === "SIGNED_OUT") {
          showError("Session not found. Please sign in again.");
        }
      },
    });

    async function completeOAuth() {
      statusEl.textContent = "Validating your Supabase session…";

      const { data, error } = await supabase.auth.getSession();
      if (error) {
        showError(error.message || "Unable to fetch session from Supabase.");
        return;
      }

      if (!data?.session) {
        showError("No active session detected. Please retry Google sign-in.");
        return;
      }

      showSuccess("You are signed in! Redirecting to your dashboard…");
      statusEl.textContent = "";

      setTimeout(() => {
        window.location.href = "profile.html";
      }, 1200);
    }

    completeOAuth().catch((err) => {
      showError(err.message || "Unexpected error during OAuth callback.");
    });
  </script>
</body>
</html>
