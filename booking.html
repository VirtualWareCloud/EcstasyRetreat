<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book a Session | Ecstasy Retreat</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>

    /* ==================== 3D GLASS CARD STYLING ==================== */
    .glass-card {
      border: 1px solid rgba(255, 20, 147, 0.35);
      background: linear-gradient(145deg, rgba(0,0,0,0.35), rgba(0,0,0,0.75));
      padding: 28px;
      border-radius: 22px;
      backdrop-filter: blur(14px);
      box-shadow:
        0 10px 25px rgba(0,0,0,0.6),
        0 0 22px rgba(255, 20, 147, 0.25),
        inset 0 0 20px rgba(255, 20, 147, 0.18);
      transition: transform .3s ease, box-shadow .3s ease;
    }
    .glass-card:hover {
      transform: translateY(-6px);
      box-shadow:
        0 18px 35px rgba(0,0,0,0.7),
        0 0 30px rgba(255, 20, 147, 0.35),
        inset 0 0 22px rgba(255, 20, 147, 0.3);
    }

    /* FIX FOR HEADER OVERLAPPING */
    .safe-top {
      padding-top: 140px !important;
    }

    /* Bottom navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #000;
      border-top: 1px solid #333;
      z-index: 50;
    }
    .bottom-nav a {
      flex: 1;
      text-align: center;
      padding: 10px 0;
      color: #ffffff;
      font-size: 13px;
    }
    .bottom-nav a i {
      display: block;
      font-size: 18px;
      margin-bottom: 3px;
    }

  </style>
</head>

<body class="bg-black text-white min-h-screen pb-32 overflow-x-hidden">

<!-- ================================================================================= -->
<!--                                      HEADER                                       -->
<!-- ================================================================================= -->

<header id="mainHeader"
  class="fixed top-0 left-0 w-full z-[999] flex justify-between items-center px-5 py-4
         bg-black/50 backdrop-blur-md border-b border-white/10 transition-all duration-1000">

  <a href="index.html">
    <img src="logo.png" class="w-32" alt="Ecstasy Retreat Logo">
  </a>

  <button id="menuBtn" class="text-white text-3xl z-[1001]">&#9776;</button>
</header>

<!-- ================================================================================= -->
<!--                             MOBILE MENU                                           -->
<!-- ================================================================================= -->

<nav id="mobileMenu"
  class="hidden fixed top-16 right-4 bg-black/95 backdrop-blur-xl p-6 rounded-xl 
         border border-pink-500/40 text-lg z-[1000] w-60 shadow-xl">
  
  <a href="index.html" class="block py-2 menu-link hover:text-pink-400">Home</a>
  <a href="Therapists_List.html" class="block py-2 menu-link hover:text-pink-400">View Therapists</a>
  <a href="login.html" class="block py-2 menu-link hover:text-pink-400">Login / Signup</a>
  <a href="image_gallery.html" class="block py-2 menu-link hover:text-pink-400">Image Gallery</a>
  <a href="video_gallery.html" class="block py-2 menu-link hover:text-pink-400">Video Gallery</a>
  <a href="join.html" class="block py-2 menu-link hover:text-pink-400">Join as Therapist</a>
  <a href="booking.html" class="block py-2 menu-link hover:text-pink-400">Book Session</a>
  <a href="contact.html" class="block py-2 menu-link hover:text-pink-400">Contact Us</a>
</nav>

<!-- FIXED TOP SPACING -->
<div class="safe-top"></div>

<!-- ================================================================================= -->
<!--                                  BOOKING FORM                                      -->
<!-- ================================================================================= -->

<section class="px-6 max-w-xl mx-auto pb-24">

  <h1 class="text-3xl font-bold text-center text-pink-500 mb-3">
    Book a Sensual Experience
  </h1>

  <p class="text-center text-white/70 text-sm mb-10">
    Select your preferred therapist, date and time. A confirmation will be sent via email and WhatsApp.
  </p>

  <form id="bookingForm" class="glass-card space-y-6">

    <!-- Therapist -->
    <div>
      <label class="block mb-1 text-sm text-pink-300">Select Therapist</label>
      <select id="therapistSelect"
              class="w-full bg-black/40 border border-pink-500/40 rounded-lg p-3 text-white"
              required>
        <option value="">Loading therapists...</option>
      </select>
    </div>

    <!-- Date -->
    <div>
      <label class="block mb-1 text-sm text-pink-300">Booking Date</label>
      <input type="date" id="bookingDate"
             class="w-full bg-black/40 border border-pink-500/40 rounded-lg p-3 text-white"
             required />
    </div>

    <!-- Time -->
    <div>
      <label class="block mb-1 text-sm text-pink-300">Booking Time</label>
      <input type="time" id="bookingTime"
             class="w-full bg-black/40 border border-pink-500/40 rounded-lg p-3 text-white"
             required />
    </div>

    <!-- Duration -->
    <div>
      <label class="block mb-1 text-sm text-pink-300">Duration</label>
      <select id="durationSelect"
              class="w-full bg-black/40 border border-pink-500/40 rounded-lg p-3 text-white"
              required>
        <option value="30 minutes">30 minutes</option>
        <option value="60 minutes">60 minutes</option>
        <option value="90 minutes">90 minutes</option>
        <option value="120 minutes">120 minutes</option>
      </select>
    </div>

    <!-- Notes -->
    <div>
      <label class="block mb-1 text-sm text-pink-300">Notes (Optional)</label>
      <textarea id="notes"
                class="w-full bg-black/40 border border-pink-500/40 rounded-lg p-3 text-white h-28"
                placeholder="Add special requests, preferences, or anything your therapist should know..."></textarea>
    </div>

    <!-- Submit Button -->
    <button id="submitBtn" type="submit"
            class="w-full bg-pink-600 hover:bg-pink-500 transition p-4 rounded-full text-lg font-bold">
      Confirm Booking
    </button>

  </form>

  <!-- SUCCESS MESSAGE -->
  <div id="successContainer" class="hidden mt-8 space-y-4 text-center">
    <p id="successMsg" class="text-green-400 font-bold text-lg">
      ✔ Booking created successfully!
    </p>

    <button id="whatsappBtn"
            class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-full border border-green-400 text-green-300 text-sm font-semibold hover:bg-green-500/10 transition">
      <i class="fa-brands fa-whatsapp text-lg"></i>
      Send booking confirmation via WhatsApp
    </button>
  </div>

</section>

<!-- ================================================================================= -->
<!--                               FOOTER SET                                          -->
<!-- ================================================================================= -->

<footer class="mt-4 mb-3 text-center text-gray-400 text-sm">
  © 2025 Ecstasy Retreat • Sensual Luxury Experience
</footer>

<footer class="bg-black/70 border-t border-white/5 text-center py-6 text-white/70 mb-24">

  <div class="flex justify-center gap-8 text-2xl mb-4">
    <a href="https://instagram.com/EcstasyRetreatSpa" target="_blank" class="hover:text-pink-400"><i class="fa-brands fa-instagram"></i></a>
    <a href="https://x.com/EcstasyRetreat" target="_blank" class="hover:text-pink-400"><i class="fa-brands fa-x-twitter"></i></a>
    <a href="https://wa.me/27500204011" target="_blank" class="hover:text-pink-400"><i class="fa-brands fa-whatsapp"></i></a>
    <a href="https://facebook.com/EcstasyRetreatSpa" target="_blank" class="hover:text-pink-400"><i class="fa-brands fa-facebook"></i></a>
    <a href="mailto:diggdeepmakeusplash@gmail.com" target="_blank" class="hover:text-pink-400"><i class="fa-solid fa-envelope"></i></a>
  </div>

  <p class="text-xs mt-3">© 2025 Ecstasy Retreat — Elite Companionship.</p>
</footer>

<nav class="bottom-nav flex justify-between">
  <a href="index.html"><i class="fa-solid fa-house"></i>Home</a>
  <a href="Therapists_List.html"><i class="fa-solid fa-users"></i>Therapists</a>
  <a href="booking.html" class="text-pink-400"><i class="fa-solid fa-calendar-check"></i>Book</a>
  <a href="contact.html"><i class="fa-solid fa-envelope"></i>Contact</a>
  <a href="login.html"><i class="fa-solid fa-user"></i>Profile</a>
</nav>

<!-- ================================================================================= -->
<!--                                  JAVASCRIPT                                       -->
<!-- ================================================================================= -->

<script>
  /* HEADER FADE (MATCHING INDEX) */
  setTimeout(() => {
    const header = document.getElementById("mainHeader");
    header.classList.add("bg-transparent", "border-transparent");
    header.classList.remove("bg-black/50", "border-white/10");
  }, 3000);

  /* MOBILE MENU */
  document.getElementById("menuBtn").onclick = () =>
    document.getElementById("mobileMenu").classList.toggle("hidden");

  document.querySelectorAll(".menu-link").forEach(link =>
    link.onclick = () => document.getElementById("mobileMenu").classList.add("hidden")
  );
</script>

<script type="module">
  import { supabase } from "./js/supabase.js";
  import { getUser } from "./js/auth.js";
  import { getTherapists } from "./js/therapists.js";

  let therapistsCache = [];
  let lastCreatedBooking = null;
  let lastTherapistForBooking = null;

  /* LOAD THERAPISTS */
  async function loadTherapists() {
    const select = document.getElementById("therapistSelect");
    select.disabled = true;

    try {
      const therapists = await getTherapists();
      therapistsCache = therapists || [];

      if (!therapistsCache.length) {
        select.innerHTML = '<option value="">No therapists available</option>';
        return;
      }

      select.innerHTML = '<option value="">Select therapist</option>';
      therapistsCache.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.full_name;
        select.appendChild(opt);
      });

      select.disabled = false;

    } catch {
      select.innerHTML = '<option value="">Error loading therapists</option>';
    }
  }

  /* CREATE BOOKING */
  async function createBooking(data) {
    const { data: result, error } = await supabase
      .from("bookings")
      .insert(data)
      .select()
      .single();

    if (error) return null;
    return result;
  }

  /* EMAIL NOTIFICATION */
  async function triggerEmail(booking, therapist, user) {
    await supabase.functions.invoke("send-booking-email", {
      body: {
        booking_id: booking.id,
        therapist_name: therapist?.full_name ?? null,
        therapist_email: therapist?.email ?? null,
        admin_email: "diggdeepmakeusplash@gmail.com",
        client_email: user.email,
        booking_date: booking.booking_date,
        booking_time: booking.booking_time,
        duration: booking.duration,
        notes: booking.notes
      }
    });
  }

  /* WHATSAPP CONFIRMATION */
  function openWhatsApp(booking, therapist) {
    const number = "27500204011";
    const msg = encodeURIComponent(
      `Hi, I'd like to confirm my booking:\n\n` +
      `Therapist: ${therapist.full_name}\n` +
      `Date: ${booking.booking_date}\n` +
      `Time: ${booking.booking_time}\n` +
      `Duration: ${booking.duration}\n` +
      `Notes: ${booking.notes || "None"}`
    );
    window.open(`https://wa.me/${number}?text=${msg}`, "_blank");
  }

  /* FORM SUBMISSION */
  document.getElementById("bookingForm").onsubmit = async (e) => {
    e.preventDefault();

    const user = await getUser();
    if (!user) return location.href = "login.html";

    const therapistId = document.getElementById("therapistSelect").value;
    const booking_date = document.getElementById("bookingDate").value;
    const booking_time = document.getElementById("bookingTime").value;
    const duration = document.getElementById("durationSelect").value;
    const notes = document.getElementById("notes").value.trim();

    const therapist = therapistsCache.find(t => t.id === therapistId);

    const payload = {
      user_id: user.id,
      therapist_id: therapistId,
      booking_date,
      booking_time,
      duration,
      notes
    };

    const booking = await createBooking(payload);

    if (booking) {
      lastCreatedBooking = booking;
      lastTherapistForBooking = therapist;

      document.getElementById("successContainer").classList.remove("hidden");

      await triggerEmail(booking, therapist, user);
    }
  };

  /* WHATSAPP BUTTON */
  document.getElementById("whatsappBtn").onclick = () => {
    openWhatsApp(lastCreatedBooking, lastTherapistForBooking);
  };

  /* INIT */
  loadTherapists();
</script>

</body>
</html>