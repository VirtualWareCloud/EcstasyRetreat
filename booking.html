<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book a Session | Ecstasy Retreat</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <!-- Desktop refinement helpers to keep booking flow centered on large screens -->
  <link rel="stylesheet" href="css/desktop-fixes.css">

  <style>

    /* ==================== 3D GLASS CARD STYLING (IMPROVED) ==================== */
    .glass-card {
      border: 2px solid rgba(255, 0, 128, 0.4); /* Thicker, more prominent border */
      /* More defined linear gradient for depth */
      background: linear-gradient(135deg, rgba(20, 20, 20, 0.8), rgba(10, 10, 10, 0.9)); 
      padding: 35px; /* Increased padding */
      border-radius: 30px; /* More modern, softer corner radius */
      backdrop-filter: blur(20px); /* Increased blur for depth */
      /* Refined box shadow for a cleaner neon effect */
      box-shadow:
        0 8px 30px rgba(0,0,0,0.7),
        0 0 40px rgba(255, 0, 128, 0.2),
        inset 0 0 25px rgba(255, 0, 128, 0.1);
      transition: transform .4s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow .4s ease;
    }
    .glass-card:hover {
      transform: translateY(-8px); /* More noticeable lift */
      box-shadow:
        0 18px 45px rgba(0,0,0,0.8),
        0 0 50px rgba(255, 0, 128, 0.45), /* Stronger hover glow */
        inset 0 0 25px rgba(255, 0, 128, 0.25);
    }
    
    /* Input Field Focus Glow */
    .form-input-glow:focus {
        outline: none;
        border-color: #ff1493; /* Deep Pink */
        box-shadow: 0 0 0 3px rgba(255, 20, 147, 0.5); /* Neon pink ring */
        background-color: rgba(0, 0, 0, 0.6) !important;
    }


    /* FIX FOR HEADER OVERLAPPING */
    .safe-top {
      padding-top: 100px !important; /* Adjusted for cleaner spacing */
    }

    /* Bottom navigation (IMPROVED) */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(15px);
      border-top: 1px solid #222;
      z-index: 50;
      display: flex; /* Ensure flex is set */
    }
    .bottom-nav a {
      flex: 1;
      text-align: center;
      padding: 12px 0; /* Increased padding */
      color: #ffffff;
      font-size: 13px;
      transition: color 0.3s ease;
    }
    .bottom-nav a:hover {
        color: #ff69b4;
    }
    .bottom-nav a i {
      display: block;
      font-size: 20px;
      margin-bottom: 3px;
    }

  </style>
  <script src="js/uiErrorHandler.js"></script>
</head>

<body class="bg-black text-white min-h-screen pb-32 overflow-x-hidden">

<header id="mainHeader"
  class="fixed top-0 left-0 w-full z-[999] flex justify-between items-center px-5 py-4
         bg-black/50 backdrop-blur-md border-b border-white/10 transition-all duration-1000">

  <a href="index.html">
    <img src="logo.png" class="w-32" alt="Ecstasy Retreat Logo">
  </a>

  <button id="menuBtn" class="text-white text-3xl z-[1001]">&#9776;</button>
</header>

<nav id="mobileMenu"
  class="hidden fixed top-16 right-4 bg-black/95 backdrop-blur-xl p-6 rounded-xl 
         border border-pink-500/40 text-lg z-[1000] w-60 shadow-xl">
  
  <a href="index.html" class="block py-2 menu-link hover:text-pink-400">Home</a>
  <a href="Therapists_List.html" class="block py-2 menu-link hover:text-pink-400">View Therapists</a>
  <a href="login.html" class="block py-2 menu-link hover:text-pink-400">Login / Signup</a>
  <a href="image_gallery.html" class="block py-2 menu-link hover:text-pink-400">Image Gallery</a>
  <a href="video_gallery.html" class="block py-2 menu-link hover:text-pink-400">Video Gallery</a>
  <a href="join.html" class="block py-2 menu-link hover:text-pink-400">Join as Therapist</a>
  <a href="booking.html" class="block py-2 menu-link hover:text-pink-400 font-bold">Book Session</a>
  <a href="contact.html" class="block py-2 menu-link hover:text-pink-400">Contact Us</a>
</nav>

<div class="safe-top"></div>

<!-- Desktop: keep booking form comfortably centered on large screens -->
<section class="px-5 md:px-10 max-w-xl mx-auto pb-24 desktop-form">

  <h1 class="text-4xl md:text-5xl font-extrabold text-center mb-4 leading-tight">
    Book Your <span class="text-pink-500">Session</span>
  </h1>

  <p class="text-center text-white/60 text-base mb-12 max-w-sm mx-auto">
    Secure your private sensual experience. Please select your preferences below.
  </p>

  <form id="bookingForm" class="glass-card space-y-7">

    <div>
      <label class="block mb-2 text-base font-semibold text-pink-300 flex items-center gap-2">
        <i class="fa-solid fa-user-tag"></i> Select Therapist
      </label>
      <select id="therapistSelect"
              class="form-input-glow w-full bg-black/50 border border-pink-500/40 rounded-xl p-4 text-white text-lg transition duration-300 appearance-none cursor-pointer"
              required>
        <option value="">Loading therapists...</option>
      </select>
    </div>

    <div>
      <label class="block mb-2 text-base font-semibold text-pink-300 flex items-center gap-2">
        <i class="fa-solid fa-calendar-alt"></i> Booking Date
      </label>
      <input type="date" id="bookingDate"
             class="form-input-glow w-full bg-black/50 border border-pink-500/40 rounded-xl p-4 text-white text-lg transition duration-300"
             required />
    </div>

    <div>
      <label class="block mb-2 text-base font-semibold text-pink-300 flex items-center gap-2">
        <i class="fa-solid fa-clock"></i> Booking Time
      </label>
      <input type="time" id="bookingTime"
             class="form-input-glow w-full bg-black/50 border border-pink-500/40 rounded-xl p-4 text-white text-lg transition duration-300"
             required />
    </div>

    <div>
      <label class="block mb-2 text-base font-semibold text-pink-300 flex items-center gap-2">
        <i class="fa-solid fa-hourglass-half"></i> Session Duration
      </label>
      <select id="durationSelect"
              class="form-input-glow w-full bg-black/50 border border-pink-500/40 rounded-xl p-4 text-white text-lg transition duration-300 appearance-none cursor-pointer"
              required>
        <option value="30 minutes">30 Minutes (Quick Relief)</option>
        <option value="60 minutes">60 Minutes (Standard)</option>
        <option value="90 minutes">90 Minutes (Deep Relaxation)</option>
        <option value="120 minutes">120 Minutes (Full Retreat)</option>
      </select>
    </div>

    <div>
      <label class="block mb-2 text-base font-semibold text-pink-300 flex items-center gap-2">
        <i class="fa-solid fa-pencil"></i> Notes (Optional)
      </label>
      <textarea id="notes"
                class="form-input-glow w-full bg-black/50 border border-pink-500/40 rounded-xl p-4 text-white h-32 transition duration-300 resize-none"
                placeholder="E.g., Special requests, preferred techniques, or any information the therapist should know prior to your session..."></textarea>
    </div>

    <button id="submitBtn" type="submit"
            class="w-full bg-pink-600 hover:bg-pink-500 transition-all p-5 rounded-full text-xl font-black mt-8 shadow-xl shadow-pink-500/40 active:scale-[0.99]">
      <i class="fa-solid fa-check-circle mr-3"></i> Confirm Booking
    </button>

  </form>

  <div id="successContainer" class="hidden mt-12 space-y-6 p-8 bg-green-900/40 border-2 border-green-500/50 rounded-2xl text-center shadow-lg shadow-green-500/20">
    <i class="fa-solid fa-circle-check text-5xl text-green-400"></i>
    <p id="successMsg" class="text-green-300 font-bold text-2xl">
      Booking Created Successfully!
    </p>
    <p class="text-white/80 text-lg">
        Your therapist has been notified. You will receive an email confirmation shortly.
    </p>

    <button id="whatsappBtn"
            class="inline-flex items-center justify-center gap-3 px-6 py-3 mt-4 rounded-full bg-green-500/10 border-2 border-green-400 text-green-300 text-base font-bold hover:bg-green-500/20 transition active:scale-[0.98]">
      <i class="fa-brands fa-whatsapp text-xl"></i>
      Confirm via WhatsApp
    </button>
  </div>

</section>

<footer class="mt-4 mb-3 text-center text-gray-400 text-sm">
  © 2025 Ecstasy Retreat • Sensual Luxury Experience
</footer>

<footer class="bg-black/70 border-t border-white/5 text-center py-6 text-white/70 mb-24">

  <!-- Desktop: align booking footer within the same centered shell -->
  <div class="desktop-footer">
    <div class="flex justify-center gap-8 text-2xl mb-4">
      <a href="https://instagram.com/EcstasyRetreatSpa" target="_blank" class="hover:text-pink-400"><i class="fa-brands fa-instagram"></i></a>
      <a href="https://x.com/EcstasyRetreat" target="_blank" class="hover:text-pink-400"><i class="fa-brands fa-x-twitter"></i></a>
      <a href="https://wa.me/27500204011" target="_blank" class="hover:text-pink-400"><i class="fa-brands fa-whatsapp"></i></a>
      <a href="https://facebook.com/EcstasyRetreatSpa" target="_blank" class="hover:text-pink-400"><i class="fa-brands fa-facebook"></i></a>
      <a href="mailto:diggdeepmakeusplash@gmail.com" target="_blank" class="hover:text-pink-400"><i class="fa-solid fa-envelope"></i></a>
    </div>

    <p class="text-xs mt-3">© 2025 Ecstasy Retreat — Elite Companionship.</p>
  </div>
</footer>

<nav class="bottom-nav flex justify-between">
  <a href="index.html"><i class="fa-solid fa-house"></i>Home</a>
  <a href="Therapists_List.html"><i class="fa-solid fa-users"></i>Therapists</a>
  <a href="booking.html" class="text-pink-400"><i class="fa-solid fa-calendar-check"></i>Book</a>
  <a href="contact.html"><i class="fa-solid fa-envelope"></i>Contact</a>
  <a href="login.html"><i class="fa-solid fa-user"></i>Profile</a>
</nav>

<script>
  /* HEADER FADE (MATCHING INDEX) */
  setTimeout(() => {
    const header = document.getElementById("mainHeader");
    header.classList.add("bg-transparent", "border-transparent");
    header.classList.remove("bg-black/50", "border-white/10");
  }, 3000);

  /* MOBILE MENU */
  uiErrorHandler.safeBind(document.getElementById("menuBtn"), "click", () =>
    document.getElementById("mobileMenu").classList.toggle("hidden"), { context: "Toggle mobile menu" }
  );

  document.querySelectorAll(".menu-link").forEach(link =>
    uiErrorHandler.safeBind(link, "click", () => document.getElementById("mobileMenu").classList.add("hidden"), { context: "Close menu" })
  );
</script>

<script type="module">
  import { supabase } from "./js/supabase.js";
  import { getUser } from "./js/auth.js";
  import { getTherapists } from "./js/therapists.js";

  const { safeBind, handleError, showError } = window.uiErrorHandler;
  let therapistsCache = [];
  let lastCreatedBooking = null;
  let lastTherapistForBooking = null;

  /* LOAD THERAPISTS */
  async function loadTherapists() {
    const select = document.getElementById("therapistSelect");
    select.disabled = true;

    try {
      const therapists = await getTherapists();
      therapistsCache = therapists || [];

      if (!therapistsCache.length) {
        select.innerHTML = '<option value="">No therapists available</option>';
        return;
      }

      select.innerHTML = '<option value="">Select therapist</option>';
      therapistsCache.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t.id;
        opt.textContent = t.full_name;
        select.appendChild(opt);
      });

      select.disabled = false;

    } catch (err) {
      handleError(err, "Therapist load failed");
      select.innerHTML = '<option value="">Error loading therapists</option>';
      select.disabled = false;
    }
  }

  /* CREATE BOOKING */
  async function createBooking(data) {
    const { data: result, error } = await supabase
      .from("bookings")
      .insert(data)
      .select()
      .single();

    if (error) throw new Error(error.message || "Booking creation failed");
    return result;
  }

  /* EMAIL NOTIFICATION */
  async function triggerEmail(booking, therapist, user) {
    await supabase.functions.invoke("send-booking-email", {
      body: {
        booking_id: booking.id,
        therapist_name: therapist?.full_name ?? null,
        therapist_email: therapist?.email ?? null,
        admin_email: "diggdeepmakeusplash@gmail.com",
        client_email: user.email,
        booking_date: booking.booking_date,
        booking_time: booking.booking_time,
        duration: booking.duration,
        notes: booking.notes
      }
    });
  }

  /* WHATSAPP CONFIRMATION */
  function openWhatsApp(booking, therapist) {
    const number = "27500204011";
    const msg = encodeURIComponent(
      `Hi, I'd like to confirm my booking:\n\n` +
      `Therapist: ${therapist.full_name}\n` +
      `Date: ${booking.booking_date}\n` +
      `Time: ${booking.booking_time}\n` +
      `Duration: ${booking.duration}\n` +
      `Notes: ${booking.notes || "None"}`
    );
    window.open(`https://wa.me/${number}?text=${msg}`, "_blank");
  }

  /* FORM SUBMISSION */
  safeBind(document.getElementById("bookingForm"), "submit", async (e) => {
    e.preventDefault();

    const user = await getUser();
    if (!user) {
      showError("Please login to complete your booking.");
      return location.href = "login.html";
    }

    const therapistId = document.getElementById("therapistSelect").value;
    const booking_date = document.getElementById("bookingDate").value;
    const booking_time = document.getElementById("bookingTime").value;
    const duration = document.getElementById("durationSelect").value;
    const notes = document.getElementById("notes").value.trim();

    const therapist = therapistsCache.find(t => t.id === therapistId);
    if (!therapist) {
      showError("Please select a therapist before booking.");
      return;
    }

    const payload = {
      user_id: user.id,
      therapist_id: therapistId,
      booking_date,
      booking_time,
      duration,
      notes
    };

    try {
      const booking = await createBooking(payload);
      lastCreatedBooking = booking;
      lastTherapistForBooking = therapist;

      document.getElementById("successContainer").classList.remove("hidden");
      await triggerEmail(booking, therapist, user);
    } catch (err) {
      handleError(err, "Booking submission failed");
    }
  }, { disableTarget: document.getElementById("submitBtn"), context: "Booking submission" });

  /* WHATSAPP BUTTON */
  safeBind(document.getElementById("whatsappBtn"), "click", () => {
    if (!lastCreatedBooking || !lastTherapistForBooking) {
      showError("Submit your booking before confirming on WhatsApp.");
      return;
    }
    openWhatsApp(lastCreatedBooking, lastTherapistForBooking);
  }, { context: "Open WhatsApp" });

  /* INIT */
  loadTherapists();
</script>

</body>
</html>
