<!DOCTYPE html>
<html lang="en">

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Join as Therapist – Ecstasy Retreat</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Font Awesome -->
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<!-- Supabase JS -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* =================================================== */
/* HEADER */
/* =================================================== */
#headerWrapper {
    background-color: rgba(0,0,0,0.6);
    transition: background-color 1.5s ease-in-out;
}
#headerWrapper.fade-bg { background-color: transparent; }

/* =================================================== */
/* NEON GLASS CARD */
/* =================================================== */
.card-glass {
    background: rgba(18,18,18,0.75);
    border: 1px solid rgba(255,0,128,0.25);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 22px;
    box-shadow: 0 0 25px rgba(255,20,147,0.18), inset 0 0 15px rgba(255,20,147,0.12);
}

/* =================================================== */
/* INPUTS */
/* =================================================== */
.input-box {
    width: 100%;
    padding: 14px;
    border-radius: 12px;
    border: 1px solid rgba(255,20,147,0.35);
    background: rgba(0,0,0,0.45);
    color: white;
    margin-bottom: 14px;
}

/* =================================================== */
/* BUTTONS */
/* =================================================== */
.primary-btn {
    background: #ff1493;
    padding: 15px;
    border-radius: 999px;
    font-weight: 700;
    text-align: center;
    box-shadow: 0 0 20px rgba(255,20,147,0.6);
    width: 100%;
}
.primary-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
.google-btn {
    background: white;
    color: black;
    padding: 15px;
    width: 100%;
    border-radius: 999px;
    font-weight: 600;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
}

/* =================================================== */
/* BOTTOM NAV */
/* =================================================== */
.bottom-nav {
    position: fixed;
    bottom: 0; left: 0;
    width: 100%;
    background: #000;
    border-top: 1px solid #333;
    z-index: 50;
}
.bottom-nav a {
    flex: 1;
    text-align: center;
    padding: 10px 0;
    color: #fff;
    font-size: 13px;
}
.bottom-nav a i {
    display: block;
    font-size: 18px;
    margin-bottom: 2px;
}
</style>
  <script src="js/uiErrorHandler.js"></script>
</head>

<body class="bg-black text-white pb-28">

<!-- =================================================== -->
<!-- HEADER -->
<!-- =================================================== -->
<header id="headerWrapper"
        class="fixed top-0 left-0 w-full z-40 py-3 px-4 flex items-center justify-between">
    <a href="index.html">
        <img src="logo.png" class="w-14">
    </a>
    <button id="menuBtn" class="text-white text-3xl">
        <i class="fa-solid fa-bars"></i>
    </button>
</header>

<!-- =================================================== -->
<!-- MOBILE MENU -->
<!-- =================================================== -->
<div id="mobileMenu"
     class="hidden fixed top-16 right-4 w-64 bg-black/95 backdrop-blur-xl p-6 z-50 rounded-xl
            border border-pink-500/40 shadow-xl">
    <nav class="space-y-4 text-lg">
        <a href="index.html" class="block hover:text-pink-400">Home</a>
        <a href="Therapists_List.html" class="block hover:text-pink-400">View Therapists</a>
        <a href="login.html" class="block hover:text-pink-400">Login / Signup</a>
        <a href="join.html" class="block text-pink-400 font-semibold">Join as Therapist</a>
    </nav>
</div>

<!-- =================================================== -->
<!-- MAIN CONTENT -->
<!-- =================================================== -->
<div class="pt-32 px-6 max-w-xl mx-auto">
    <h1 class="text-4xl font-bold text-center text-pink-500 mb-8">
        Become an Ecstasy Retreat Therapist
    </h1>

    <!-- APPLICATION FORM -->
    <form id="joinForm" class="space-y-8">

        <!-- HEADSHOT -->
        <div class="card-glass">
            <label class="block font-semibold mb-2">Upload Headshot (Required)</label>
            <input type="file" id="headshot" accept="image/*" capture="camera" class="input-box" required />
        </div>

        <!-- BASIC INFO -->
        <div class="card-glass">
            <input type="text" id="fullName" placeholder="Full Name*" class="input-box">
            <input type="tel" id="whatsapp" placeholder="WhatsApp Number (+27…)*" class="input-box" required>
            <input type="email" id="email" placeholder="Email Address*" class="input-box" required>
            <input type="password" id="password" placeholder="Password*" class="input-box">

            <!-- TOWN DROPDOWN -->
            <label>Town*</label>
            <select id="town" class="input-box" required>
              <option value="">Select your town</option>
              <option value="Johannesburg">Johannesburg</option>
              <option value="Pretoria">Pretoria</option>
              <option value="Cape Town">Cape Town</option>
              <option value="Durban">Durban</option>
              <option value="Port Elizabeth">Port Elizabeth</option>
              <option value="Bloemfontein">Bloemfontein</option>
              <option value="Polokwane">Polokwane</option>
              <option value="Nelspruit">Nelspruit</option>
              <option value="Rustenburg">Rustenburg</option>
              <option value="Kimberley">Kimberley</option>
              <option value="East London">East London</option>
              <option value="George">George</option>
              <option value="Pietermaritzburg">Pietermaritzburg</option>
              <option value="Welkom">Welkom</option>
              <option value="Mthatha">Mthatha</option>
              <option value="Potchefstroom">Potchefstroom</option>
              <option value="Klerksdorp">Klerksdorp</option>
              <option value="Vereeniging">Vereeniging</option>
              <option value="Benoni">Benoni</option>
              <option value="Boksburg">Boksburg</option>
              <option value="Kempton Park">Kempton Park</option>
              <option value="Krugersdorp">Krugersdorp</option>
              <option value="Centurion">Centurion</option>
              <option value="Midrand">Midrand</option>
              <option value="Soweto">Soweto</option>
              <option value="Randburg">Randburg</option>
              <option value="Roodepoort">Roodepoort</option>
              <option value="Stellenbosch">Stellenbosch</option>
              <option value="Somerset West">Somerset West</option>
              <option value="Paarl">Paarl</option>
              <option value="Mossel Bay">Mossel Bay</option>
              <option value="Hermanus">Hermanus</option>
              <option value="Ballito">Ballito</option>
              <option value="Umhlanga">Umhlanga</option>
              <option value="Richards Bay">Richards Bay</option>
              <option value="Secunda">Secunda</option>
              <option value="Bethlehem">Bethlehem</option>
              <option value="Phalaborwa">Phalaborwa</option>
              <option value="Tzaneen">Tzaneen</option>
              <option value="Thohoyandou">Thohoyandou</option>
              <option value="Giyani">Giyani</option>
              <option value="Mahikeng">Mahikeng</option>
              <option value="Upington">Upington</option>
              <option value="Other">Other (please contact us)</option>
            </select>

            <input type="number" id="age" placeholder="Age (Optional)" class="input-box">
            <input type="text" id="languages" placeholder="Languages (Optional)" class="input-box">
        </div>

        <!-- SERVICES -->
        <div class="card-glass">
            <h2 class="text-xl font-bold text-pink-400 mb-4">Select Your Services</h2>
            <div class="grid gap-3">
                <label><input type="checkbox" value="tantric" class="service-box"> Tantric Massage</label>
                <label><input type="checkbox" value="nuru" class="service-box"> Nuru Massage</label>
                <label><input type="checkbox" value="sensual" class="service-box"> Full Body Sensual Massage</label>
            </div>
        </div>

        <!-- BIO -->
        <div class="card-glass">
            <h2 class="text-xl font-bold text-pink-400 mb-3">Auto-Generated Bio</h2>
            <textarea id="bioOutput" class="w-full h-40 bg-black/40 border border-pink-500/40 rounded-lg p-3"
                      placeholder="Your bio will be generated here…" readonly></textarea>
        </div>

        <!-- BUTTONS -->
        <button type="submit" id="submitBtn" class="primary-btn" disabled>Submit Application</button>
        <button type="button" id="googleSignup" class="google-btn">
            <img src="https://www.svgrepo.com/show/475656/google-color.svg" width="22">
            Sign up with Google
        </button>
    </form>
</div>

<!-- =================================================== -->
<!-- FOOTER -->
<!-- =================================================== -->
<footer class="mt-16 mb-6 text-center text-gray-400 text-sm">
    © 2025 Ecstasy Retreat • Sensual Luxury Experience
</footer>

<!-- =================================================== -->
<!-- SUPABASE SCRIPT -->
<!-- =================================================== -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

// ✅ Supabase Configuration
const SUPABASE_URL = "https://jeregnymrknddwbbbvrm.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplcmVnbnltcmtuZGR3YmJidnJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NjE1NjYsImV4cCI6MjA...";
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
const { safeBind, handleError, showError } = window.uiErrorHandler;

// ====================== AUTO BIO ======================
const serviceDescriptions = {
  tantric: "Specialising in ancient Tantric techniques that awaken sensual energy.",
  nuru: "Offering intimate Nuru body-to-body experiences for heightened arousal.",
  sensual: "Full-body sensual massage exploring every erogenous zone."
};

const boxes = document.querySelectorAll(".service-box");
const bio = document.getElementById("bioOutput");
boxes.forEach(box => {
  safeBind(box, "change", () => {
    const selected = Array.from(boxes)
      .filter(b => b.checked)
      .map(b => serviceDescriptions[b.value]);
    bio.value = selected.join("\n\n");
  }, { context: "Service selection" });
});

// ====================== FORM VALIDATION ======================
const requiredFields = ["town", "headshot", "whatsapp", "email"];
const submitBtn = document.getElementById("submitBtn");

document.querySelectorAll("#town, #headshot, #whatsapp, #email").forEach(input => {
  safeBind(input, "input", checkFormValidity, { context: "Join form validation" });
  safeBind(input, "change", checkFormValidity, { context: "Join form validation" });
});

function checkFormValidity() {
  const isValid = requiredFields.every(id => {
    const el = document.getElementById(id);
    if (id === "headshot") return el.files.length > 0;
    return el.value.trim() !== "";
  });
  submitBtn.disabled = !isValid;
}

// ====================== NORMAL SIGNUP ======================
safeBind(document.getElementById("joinForm"), "submit", async (e) => {
  e.preventDefault();

  const fullName = document.getElementById("fullName").value.trim();
  const whatsapp = document.getElementById("whatsapp").value.trim();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const town = document.getElementById("town").value;
  const age = document.getElementById("age").value;
  const languages = document.getElementById("languages").value;
  const bioText = document.getElementById("bioOutput").value;
  const headshot = document.getElementById("headshot").files[0];

  if (!town || !headshot || !whatsapp || !email) {
    showError("Please complete all required fields: Town, Headshot, WhatsApp, and Email.");
    return;
  }

  try {
    const { data: signupData, error: signupError } = await supabase.auth.signUp({
      email,
      password,
      options: { data: { fullName, whatsapp, town } },
    });
    if (signupError) throw new Error(signupError.message);

    const userId = signupData.user.id;
    const fileName = `therapists/${userId}_${Date.now()}.jpg`;
    const { error: uploadError } = await supabase.storage.from("headshots").upload(fileName, headshot);
    if (uploadError) throw new Error(uploadError.message || "Upload failed");

    const { error: insertError } = await supabase.from("therapists").insert([
      {
        auth_id: userId,
        display_name: fullName,
        whatsapp,
        email,
        town,
        age,
        languages,
        bio: bioText,
        main_photo: fileName
      }
    ]);

    if (insertError) throw new Error(insertError.message || "Profile creation failed");

    showError("Application submitted successfully!");
    window.location.href = "thankyou.html";
  } catch (err) {
    handleError(err, "Therapist signup failed");
  }
}, { disableTarget: submitBtn, context: "Therapist signup" });

// ====================== GOOGLE SIGNUP ======================
safeBind(document.getElementById("googleSignup"), "click", async () => {
  const { error } = await supabase.auth.signInWithOAuth({
    provider: "google",
    options: { redirectTo: window.location.origin + "/join.html#googleReturn" }
  });
  if (error) handleError(error, "Google signup failed");
}, { disableTarget: document.getElementById("googleSignup"), context: "Google signup" });

// ====================== GOOGLE RETURN ======================
safeBind(window, "load", async () => {
  try {
    const { data: { session } } = await supabase.auth.getSession();
    if (session && window.location.hash.includes("googleReturn")) {
      const user = session.user;
      if (!user) return;

      const { data: existing } = await supabase
        .from("therapists")
        .select("auth_id")
        .eq("auth_id", user.id)
        .single();

      if (!existing) {
        await supabase.from("therapists").insert([
          {
            auth_id: user.id,
            display_name: user.user_metadata.fullName || user.email.split("@")[0],
            email: user.email,
            whatsapp: "",
            town: "",
            bio: "New Google-verified therapist profile.",
            main_photo: ""
          }
        ]);
      }

      window.location.href = "thankyou.html";
    }
  } catch (err) {
    handleError(err, "Google return handling");
  }
});
</script>

<!-- =================================================== -->
<!-- MENU SCRIPT -->
<!-- =================================================== -->
<script>
setTimeout(() => {
    document.getElementById("headerWrapper").classList.add("fade-bg");
}, 3000);

uiErrorHandler.safeBind(document.getElementById("menuBtn"), "click", () =>
  document.getElementById("mobileMenu").classList.toggle("hidden"), { context: "Toggle mobile menu" }
);
</script>

</body>
</html>
